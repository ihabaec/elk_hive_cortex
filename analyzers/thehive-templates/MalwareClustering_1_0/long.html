<div class="panel panel-danger" ng-if="!success">
    <div class="panel-heading">
        <strong>{{(artifact.data || artifact.attachment.name) | fang}}</strong>
    </div>
    <div class="panel-body">
        {{content.errorMessage}}
    </div>
</div>

<div ng-switch="content.response_code" ng-if="success">
    <div class="panel panel-info" ng-if="content.info">
        <div class="panel-heading">
            <strong>File Summary</strong>
        </div>
        <div class="panel-body">
            <dl class="dl-horizontal">
                <dt>Name</dt>
                <dd class="wrap">{{content.info.name}}</dd>
            </dl>
            <dl class="dl-horizontal" ng-if="content.info.tag">
                <dt>Family</dt>
                <dd class="wrap">{{content.info.tag}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>SHA-256</dt>
                <dd class="wrap">{{content.info.sha256}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>SHA-1</dt>
                <dd class="wrap">{{content.info.sha1}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>MD5</dt>
                <dd class="wrap">{{content.info.md5}}</dd>
            </dl>
            <dl class="dl-horizontal" ng-if="content.info.impfuzzy">
                <dt>Impfuzzy</dt>
                <dd class="wrap">{{content.info.impfuzzy}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>ApiScout Vector</dt>
                <dd class="wrap">{{content.info.scout_result}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>ApiScout Confidence</dt>
                <dd class="wrap">{{content.info.scout_confidence}}</dd>
            </dl>
        </div>
    </div>

    <div class="panel panel-info" ng-if="::content.families" ng-init="families_limit = 10">
        <div class="panel-heading">
            <strong>Similar Families</strong>
            <span class="pull-right" ng-show="::content.families.length > 10">
                <a href ng-show="families_limit===10" ng-click="families_limit = undefined">Show All
                    ({{::content.families.length}})</a>
                <a href ng-show="!families_limit" ng-click="families_limit = 10">Show less</a>
            </span>
        </div>
        <div class="panel-body">
            <p>Similar Families for ApiScout matchVectors</p>
            <table class="table table-hover">
                <tr>
                    <th>Family</th>
                    <th>Score</th>
                </tr>
                <tr ng-repeat="family in content.families | limitTo:families_limit">
                    <td><span ng-class="{'text-danger': family.max >= 70}">{{::family.tag}}</span></td>
                    <td><span ng-class="{'text-danger': family.max >= 70}">{{::family.max}}</span></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="panel panel-info" ng-if="::content.files">
        <div class="panel-heading">
            <strong>Similar Sha256</strong>
        </div>
        <div class="panel-body">
            <table class="table table-hover">
                <tr>
                    <th>Family</th>
                    <th>Sha256</th>
                    <th>Score</th>
                </tr>
                <tr ng-repeat="file in content.files">
                    <td><span ng-class="{'text-danger': file.max >= 70}">{{file.tag}}</span></td>
                    <td><span ng-class="{'text-danger': file.max >= 70}">{{file.sha256}}</span></td>
                    <td><span ng-class="{'text-danger': file.max >= 70}">{{file.max}}</span></td>
                </tr>
            </table>
        </div>
    </div>

    <div style="display:none;" ng-if="::content.cluster">
        <script>
            $(document).ready(function () {
                $.when(
                    $.getScript("https://gw.alipayobjects.com/os/antv/pkg/_antv.g6-3.7.0/dist/g6.min.js"),
                    $.Deferred(function (deferred) {
                        $(deferred.resolve);
                    })
                ).done(function () {

                    function tableToJson(table) {
                        var data = [];
                        var headers = [];
                        for (var i = 0; i < table.rows[0].cells.length; i++) {
                            headers[i] = table.rows[0].cells[i].innerHTML;
                        }
                        for (var i = 1; i < table.rows.length; i++) {
                            var tableRow = table.rows[i]; var rowData = {};
                            for (var j = 0; j < tableRow.cells.length; j++) {
                                rowData[headers[j]] = tableRow.cells[j].innerHTML;
                            } data.push(rowData);
                        }
                        return data;
                    }

                    function unique(array) {
                        return $.grep(array, function (el, index) {
                            return index == $.inArray(el, array);
                        });
                    }

                    var table = tableToJson($('#cluster')[0]);

                    var families_list = [];
                    $.each(table, function (index, el) {
                        families_list.push(el['s_family']);
                        families_list.push(el['r_family']);
                    });
                    families_list = unique(families_list);

                    var sha256_list = [];
                    $.each(table, function (index, el) {
                        sha256_list.push(el['s_sha256']);
                        sha256_list.push(el['r_sha256']);
                    });
                    sha256_list = unique(sha256_list);

                    var nodes_list = [];
                    $.each(sha256_list, function (index, el) {
                        nodes_list.push({ 'id': el, 'label': el.substring(0, 7) + "..." });
                    });

                    var edges_list = [];
                    $.each(table, function (index, el) {
                        edges_list.push({ 'target': el['r_sha256'], 'source': el['s_sha256'], 'label': el['Score'] });
                    });

                    var data = { 'nodes': nodes_list, 'edges': edges_list };

                    let simulation;
                    const graph = new G6.Graph({
                        container: 'mountNode',
                        width: window.innerWidth,
                        height: 600,
                        layout: {
                            type: 'force'
                        },
                        modes: {
                            default: ['zoom-canvas', 'drag-canvas', 'drag-node'],
                        },
                        defaultEdge: {
                            style: {
                                stroke: '#b3b3b3',
                                lineWidth: 5,
                            }
                        },
                        defaultNode: {
                            size: 20,
                            style: {
                                fill: '#00aaff'
                            }
                        }
                    });

                    const nodes = data.nodes;
                    graph.data({
                        nodes,
                        edges: data.edges.map(function (edge, i) {
                            edge.id = 'edge' + i;
                            return Object.assign({}, edge);
                        }),
                    });
                    graph.render();

                });
            });

        </script>

        <table id="cluster">
            <tr>
                <th>s_sha256</th>
                <th>s_family</th>
                <th>Score</th>
                <th>r_sha256</th>
                <th>r_family</th>
            </tr>
            <tr ng-repeat="node in content.cluster">
                <td>{{node['m2.sha256']}}</td>
                <td>{{node['m2.tag']}}</td>
                <td>{{node['p.value']}}</td>
                <td>{{node['m3.sha256']}}</td>
                <td>{{node['m3.tag']}}</td>
            </tr>
        </table>
    </div>

    <div class="panel panel-info" ng-if="::content.cluster">
        <div class="panel-heading">
            <strong>Cluster Map</strong>
        </div>
        <div class="panel-body">
            <div id="mountNode"></div>
        </div>
    </div>

    <div class="panel panel-info" ng-if="::content.cluster_count">
        <div class="panel-heading">
            <strong>Cluster Map</strong>
        </div>
        <div class="panel-body">
            Cluster too big to be shown! {{content.cluster_count}} connections.
        </div>
    </div>

</div>