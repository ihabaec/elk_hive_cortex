<div class="panel panel-info" ng-if="success">
  <div class="panel-heading bg-danger text-white">
    <h4 class="panel-title">
      üìå Vulnerability Lookup:
      <strong>
        <a target="_blank" class="text-white"
          href="{{content.url || ('https://vulnerability.circl.lu/vuln/' + (content.vulnerability.cveMetadata.cveId || content.vulnerability.id))}}">
          {{content.vulnerability.cveMetadata.cveId || content.vulnerability.id}}
        </a>
      </strong>
    </h4>
  </div>

  <div class="panel-body">

    <!-- Basic Information -->
    <h4 class="text-danger">üîç Basic Information</h4>
    <dl class="dl-horizontal">
      <dt>Assigner:</dt>
      <dd>{{content.vulnerability.cveMetadata.assignerShortName || content.vulnerability.sourceIdentifier}}</dd>
      <dt>Status:</dt>
      <dd>{{content.vulnerability.cveMetadata.state || content.vulnerability.vulnStatus}}</dd>
      <dt>Date Published:</dt>
      <dd>{{content.vulnerability.cveMetadata.datePublished || content.vulnerability.published | date:'medium'}}</dd>
      <dt>Last Updated:</dt>
      <dd>{{content.vulnerability.cveMetadata.dateUpdated || content.vulnerability.lastModified | date:'medium'}}</dd>
    </dl>

    <hr>

    <!-- Description -->
    <h4 class="text-danger">üìù Description</h4>
    <p>
      {{(content.vulnerability.containers.cna.descriptions[0].value || content.vulnerability.descriptions[0].value)}}
    </p>

    <hr>

    <style>
      .cvss dl {
        display: grid;
        grid-template-columns: max-content auto;
        gap: 5px 10px;
        align-items: center;
      }

      .cvss .label {
        display: inline-block;
        font-size: 90%;
        padding: 3px 6px;
        margin-left: 5px;
      }
    </style>


    <!-- Tentative VLAI support -->
    <div
      ng-if="content.vulnerability.containers.cna.vlai && (content.vulnerability.containers.cna.vlai.summary || content.vulnerability.containers.cna.vlai)">
      <h4 class="text-danger">ü§ñ AI Analysis (VLAI)</h4>
      <blockquote style="background:#f7f7f7;padding:1em;border-left:5px solid #aaa;">
        {{content.vulnerability.containers.cna.vlai.summary || content.vulnerability.containers.cna.vlai}}
      </blockquote>
      <div ng-if="content.vulnerability.containers.cna.vlai.confidence">
        <small>Confidence: {{content.vulnerability.containers.cna.vlai.confidence * 100 | number:1}}%</small>
      </div>
    </div>

    <div ng-if="content.vulnerability.vlai">
      <h4 class="text-danger">ü§ñ AI Analysis (VLAI)</h4>
      <blockquote style="background:#f7f7f7;padding:1em;border-left:5px solid #aaa;">
        {{content.vulnerability.vlai.summary || content.vulnerability.vlai}}
      </blockquote>
    </div>


    <!-- Problem Types: CAPEC and CWE -->
    <div
      ng-if="content.vulnerability.containers.cna.problemTypes && content.vulnerability.containers.cna.problemTypes.length">
      <h4 class="text-danger">üß¨ Weakness & Attack Patterns</h4>
      <ul>
        <li ng-repeat="pt in content.vulnerability.containers.cna.problemTypes">
          <span ng-repeat="desc in pt.descriptions">
            <span ng-if="desc.cweId">CWE: {{desc.cweId}} - {{desc.description}}</span>
            <span ng-if="!desc.cweId">{{desc.value || desc.description}}</span>
          </span>
        </li>
      </ul>
    </div>
    <div ng-if="content.vulnerability.containers.cna.impacts && content.vulnerability.containers.cna.impacts.length">
      <h4 class="text-danger">üí• Impact (CAPEC)</h4>
      <ul>
        <li ng-repeat="impact in content.vulnerability.containers.cna.impacts">
          <span ng-repeat="desc in impact.descriptions">
            <span ng-if="impact.capecId">CAPEC: {{impact.capecId}} - {{desc.value}}</span>
          </span>
        </li>
      </ul>
    </div>

    <!-- CVSS Metrics (All Versions: 2.0, 3.0, 3.1, 4.0) -->
    <h4 class="text-danger">üìä CVSS Metrics</h4>
    <div class="cvss">
      <!-- CNA format -->
      <div ng-if="content.vulnerability.containers.cna.metrics">
        <div ng-repeat="metric in content.vulnerability.containers.cna.metrics">
          <dl ng-if="metric.cvssV4_0">
            <dt>CVSS Version:</dt>
            <dd>{{metric.cvssV4_0.version}}</dd>
            <dt>Severity:</dt>
            <dd><span class="label label-danger">{{metric.cvssV4_0.baseSeverity}}</span></dd>
            <dt>Base Score:</dt>
            <dd>{{metric.cvssV4_0.baseScore}}</dd>
            <dt>Vector:</dt>
            <dd>{{metric.cvssV4_0.vectorString}}</dd>
          </dl>
          <dl ng-if="metric.cvssV3_1 || metric.cvssV3_0">
            <dt>CVSS Version:</dt>
            <dd>{{(metric.cvssV3_1 || metric.cvssV3_0).version}}</dd>
            <dt>Severity:</dt>
            <dd><span class="label label-danger">{{(metric.cvssV3_1 || metric.cvssV3_0).baseSeverity}}</span></dd>
            <dt>Base Score:</dt>
            <dd>{{(metric.cvssV3_1 || metric.cvssV3_0).baseScore}}</dd>
            <dt>Vector:</dt>
            <dd>{{(metric.cvssV3_1 || metric.cvssV3_0).vectorString}}</dd>
          </dl>
          <dl ng-if="metric.cvssV2_0">
            <dt>CVSS Version:</dt>
            <dd>{{metric.cvssV2_0.version}}</dd>
            <dt>Severity:</dt>
            <dd><span class="label label-danger">{{metric.cvssV2_0.baseSeverity}}</span></dd>
            <dt>Base Score:</dt>
            <dd>{{metric.cvssV2_0.baseScore}}</dd>
            <dt>Vector:</dt>
            <dd>{{metric.cvssV2_0.vectorString}}</dd>
          </dl>
        </div>
      </div>
      <!-- NVD format -->
      <div ng-if="content.vulnerability.metrics">
        <div ng-repeat="(key, metricList) in content.vulnerability.metrics">
          <div ng-repeat="metric in metricList">
            <dl>
              <dt>CVSS Version:</dt>
              <dd>{{metric.cvssData.version}}</dd>
              <dt>Severity:</dt>
              <dd><span class="label label-danger">{{metric.cvssData.baseSeverity}}</span></dd>
              <dt>Base Score:</dt>
              <dd>{{metric.cvssData.baseScore}}</dd>
              <dt>Vector:</dt>
              <dd>{{metric.cvssData.vectorString}}</dd>
            </dl>
          </div>
        </div>
      </div>
      <!-- ADP (Apple-style, e.g. CVSS in adp.metrics) -->
      <div ng-if="content.vulnerability.containers.adp">
        <div ng-repeat="adp in content.vulnerability.containers.adp">
          <div ng-repeat="metric in adp.metrics">
            <dl ng-if="metric.cvssV4_0">
              <dt>CVSS Version:</dt>
              <dd>{{metric.cvssV4_0.version}}</dd>
              <dt>Severity:</dt>
              <dd><span class="label label-danger">{{metric.cvssV4_0.baseSeverity}}</span></dd>
              <dt>Base Score:</dt>
              <dd>{{metric.cvssV4_0.baseScore}}</dd>
              <dt>Vector:</dt>
              <dd>{{metric.cvssV4_0.vectorString}}</dd>
            </dl>
            <dl ng-if="metric.cvssV3_1">
              <dt>CVSS Version:</dt>
              <dd>{{metric.cvssV3_1.version}}</dd>
              <dt>Severity:</dt>
              <dd><span class="label label-danger">{{metric.cvssV3_1.baseSeverity}}</span></dd>
              <dt>Base Score:</dt>
              <dd>{{metric.cvssV3_1.baseScore}}</dd>
              <dt>Vector:</dt>
              <dd>{{metric.cvssV3_1.vectorString}}</dd>
            </dl>
            <dl ng-if="metric.cvssV3_0">
              <dt>CVSS Version:</dt>
              <dd>{{metric.cvssV3_0.version}}</dd>
              <dt>Severity:</dt>
              <dd><span class="label label-danger">{{metric.cvssV3_0.baseSeverity}}</span></dd>
              <dt>Base Score:</dt>
              <dd>{{metric.cvssV3_0.baseScore}}</dd>
              <dt>Vector:</dt>
              <dd>{{metric.cvssV3_0.vectorString}}</dd>
            </dl>
            <dl ng-if="metric.cvssV2_0">
              <dt>CVSS Version:</dt>
              <dd>{{metric.cvssV2_0.version}}</dd>
              <dt>Severity:</dt>
              <dd><span class="label label-danger">{{metric.cvssV2_0.baseSeverity}}</span></dd>
              <dt>Base Score:</dt>
              <dd>{{metric.cvssV2_0.baseScore}}</dd>
              <dt>Vector:</dt>
              <dd>{{metric.cvssV2_0.vectorString}}</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <h4 class="text-danger">üí° Affected Products</h4>
    <ul>
      <!-- CNA-style affected products (modern format, preferred) -->
      <li
        ng-if="content.vulnerability.containers && content.vulnerability.containers.cna && content.vulnerability.containers.cna.affected"
        ng-repeat="product in content.vulnerability.containers.cna.affected">
        <strong>{{product.vendor}} - {{product.product}}</strong>
        <ul>
          <li ng-repeat="version in product.versions">
            <span ng-if="version.status=='affected'">
              <span class="label label-danger">Vulnerable</span>
            </span>
            <span ng-if="version.status=='unaffected'">
              <span class="label label-success">Patched</span>
            </span>
            <span ng-if="!version.status">
              <span class="label label-default">Unknown</span>
            </span>
            <!-- Robust display of version range, using multiple possible keys and type -->
            <span ng-if="version.version">
              <span ng-if="version.versionType == 'git'">
                Commit: <code>{{version.version | limitTo:12}}</code>
              </span>
              <span ng-if="!version.versionType || version.versionType == 'semver' || version.versionType == 'custom'">
                Version: <strong>{{version.version}}</strong>
              </span>
            </span>
            <span ng-if="version.lessThan">
              <span ng-if="version.versionType == 'git'">
                &nbsp;Less than commit: <code>{{version.lessThan | limitTo:12}}</code>
              </span>
              <span ng-if="!version.versionType || version.versionType == 'semver' || version.versionType == 'custom'">
                &nbsp;Less than version: <strong>{{version.lessThan}}</strong>
              </span>
            </span>
            <span ng-if="version.lessThanOrEqual">
              <span ng-if="version.versionType == 'git'">
                &nbsp;Less than or equal to commit: <code>{{version.lessThanOrEqual | limitTo:12}}</code>
              </span>
              <span ng-if="!version.versionType || version.versionType == 'semver' || version.versionType == 'custom'">
                &nbsp;Less than or equal to version: <strong>{{version.lessThanOrEqual}}</strong>
              </span>
            </span>
            <span ng-if="version.greaterThan">
              <span ng-if="version.versionType == 'git'">
                &nbsp;Greater than commit: <code>{{version.greaterThan | limitTo:12}}</code>
              </span>
              <span ng-if="!version.versionType || version.versionType == 'semver' || version.versionType == 'custom'">
                &nbsp;Greater than version: <strong>{{version.greaterThan}}</strong>
              </span>
            </span>
            <span ng-if="version.greaterThanOrEqual">
              <span ng-if="version.versionType == 'git'">
                &nbsp;Greater than or equal to commit: <code>{{version.greaterThanOrEqual | limitTo:12}}</code>
              </span>
              <span ng-if="!version.versionType || version.versionType == 'semver' || version.versionType == 'custom'">
                &nbsp;Greater than or equal to version: <strong>{{version.greaterThanOrEqual}}</strong>
              </span>
            </span>
            <span
              ng-if="!version.version && !version.lessThan && !version.lessThanOrEqual && !version.greaterThan && !version.greaterThanOrEqual">
              (unspecified version)
            </span>
          </li>
        </ul>
      </li>

      <!-- NVD-style configurations (fallback) -->
      <li
        ng-if="content.vulnerability.configurations && content.vulnerability.configurations[0] && content.vulnerability.configurations[0].nodes"
        ng-repeat="node in content.vulnerability.configurations[0].nodes">
        <ul>
          <li ng-repeat="cpe in node.cpeMatch">
            <strong>{{cpe.criteria || cpe.cpe23Uri}}</strong>
            <span ng-if="cpe.versionStartIncluding">from {{cpe.versionStartIncluding}}</span>
            <span ng-if="cpe.versionEndIncluding">to {{cpe.versionEndIncluding}}</span>
            <span ng-if="cpe.versionEndExcluding">to before {{cpe.versionEndExcluding}}</span>
            <span ng-if="cpe.versionStartExcluding">after {{cpe.versionStartExcluding}}</span>
            <span ng-if="cpe.vulnerable">
              <span class="label label-danger">Vulnerable</span>
            </span>
            <span ng-if="cpe.vulnerable === false">
              <span class="label label-success">Patched</span>
            </span>
          </li>
        </ul>
      </li>

      <!-- Fallback: At least show some product info if neither block works -->
      <li
        ng-if="!(content.vulnerability.containers && content.vulnerability.containers.cna && content.vulnerability.containers.cna.affected) &&
                !(content.vulnerability.configurations && content.vulnerability.configurations[0] && content.vulnerability.configurations[0].nodes)">
        <span>No affected product/version information available in this record.</span>
      </li>
    </ul>

    <hr>

    <!-- EPSS Exploit Prediction -->
    <h4 class="text-danger">üìà Exploit Prediction (EPSS)</h4>
    <dl class="dl-horizontal" ng-if="content.epss.data && content.epss.data.length">
      <dt>EPSS Score:</dt>
      <dd>{{content.epss.data[0].epss}}</dd>
      <dt>Percentile:</dt>
      <dd>{{content.epss.data[0].percentile}}</dd>
      <dt>Date:</dt>
      <dd>{{content.epss.data[0].date}}</dd>
    </dl>
    <p ng-if="!content.epss.data.length">No EPSS data available.</p>

    <div ng-if="content.epss.data && content.epss.data.length && content.epss.data[0]['time-series']">
      <h5>
        EPSS History
        <button class="btn btn-xs btn-default" ng-click="showEpssHistory = !showEpssHistory">{{showEpssHistory ? 'Hide'
          : 'Show'}}</button>
      </h5>
      <table class="table table-condensed" ng-show="showEpssHistory">
        <thead>
          <tr>
            <th>Date</th>
            <th>Score</th>
            <th>Percentile</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="point in content.epss.data[0]['time-series']">
            <td>{{point.date}}</td>
            <td>{{point.epss}}</td>
            <td>{{point.percentile}}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr>
    <!-- CISA Known Exploited Vulnerability -->
    <div ng-if="content.vulnerability.containers.adp">
      <div ng-repeat="adp in content.vulnerability.containers.adp">
        <div ng-repeat="metric in adp.metrics">
          <div ng-if="metric.other && metric.other.type == 'kev'">
            <h4 class="text-danger">üö® CISA Known Exploited Vulnerability</h4>
            <dl class="dl-horizontal">
              <dt>Date added:</dt>
              <dd>{{metric.other.content.dateAdded}}</dd>
              <dt>Reference:</dt>
              <dd>
                <a target="_blank" href="{{metric.other.content.reference}}">{{metric.other.content.reference}}</a>
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <!-- References -->
    <h4 class="text-danger">üìö References</h4>
    <ul>
      <li ng-repeat="ref in (content.vulnerability.containers.cna.references || content.vulnerability.references)">
        <a target="_blank" href="{{ref.url}}">{{ref.url}}</a>
      </li>
    </ul>

    <hr>

    <!-- Community Comments -->
    <h4 class="text-danger">üí¨ Community Insights ({{content.comments.metadata.count}})</h4>
    <p ng-if="content.comments.metadata.count === 0">No community comments available.</p>
    <div ng-repeat="comment in content.comments.data" style="margin-bottom:20px;">
      <strong>{{comment.title}}</strong><br>
      <em>{{comment.author.name}}</em> ({{comment.creation_timestamp | date:'medium'}})
      <div ng-bind-html="comment.description | markdown"></div>
      <a target="_blank" class="btn btn-xs btn-info" href="https://vulnerability.circl.lu/comment/{{comment.uuid}}">
        üîó View Comment
      </a>
    </div>

    <hr>

    <!-- Sightings -->
    <h4 class="text-danger">üåê Recent Sightings ({{content.sightings.metadata.count}})</h4>
    <p ng-if="content.sightings.metadata.count === 0">No sightings reported.</p>
    <ul ng-if="content.sightings.metadata.count > 0" style="max-height:250px; overflow:auto;">
      <li ng-repeat="sighting in content.sightings.data">
        <strong>{{sighting.type | uppercase}}</strong> -
        <a target="_blank" href="{{sighting.source}}">{{sighting.source}}</a>
        ({{sighting.creation_timestamp | date:'medium'}})
      </li>
    </ul>

  </div>
</div>

<div class="panel panel-danger" ng-if="!success">
  <div class="panel-heading">
    <strong>Error fetching vulnerability data</strong>
  </div>
  <div class="panel-body">
    {{content.errorMessage}}
  </div>
</div>